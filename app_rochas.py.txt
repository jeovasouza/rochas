import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
import numpy as np

# Configura√ß√£o de P√°gina Industrial
st.set_page_config(page_title="Analytics Pro | Rochas", layout="wide")

@st.cache_data
def load_and_prep():
    df = pd.read_csv('Dados brutos.xlsx - Plan1.csv')
    # Limpeza S√™nior
    for col in ['Consumo Total', 'Custo Direto Unit.', 'CIF', 'Custo Padr√£o']:
        df[col] = pd.to_numeric(df[col], errors='coerce').fillna(0)
    
    # C√°lculo de m√©tricas de efici√™ncia
    df['Custo_por_M2'] = (df['Custo Padr√£o'] / df['Consumo Total']).replace([np.inf, -np.inf], 0).fillna(0)
    return df

df = load_and_prep()

# --- SIDEBAR: DESIGN & PAR√ÇMETROS ---
st.sidebar.title("üõ†Ô∏è Painel de Controle")
with st.sidebar.expander("üé® Estilo & Design", expanded=True):
    tema_ref = st.selectbox("Esquema de Cores", ["plotly_dark", "plotly_white", "seaborn"])
    estilo_grafico = st.radio("Modelo de Gr√°fico", ["Barras", "Treemap", "Sunburst"])

with st.sidebar.expander("ü§ñ Intelig√™ncia de Auditoria", expanded=True):
    sensibilidade = st.slider("Sensibilidade da IA (Desvios)", 1.0, 3.0, 2.0)
    st.caption("Ajuste para identificar produtos muito acima da m√©dia de custo.")

# --- L√ìGICA DE AUDITORIA (Z-SCORE) ---
# Identificando produtos que custam significativamente mais que a m√©dia do processo
df['Media_Processo'] = df.groupby('Complemento')['Custo_por_M2'].transform('mean')
df['Desvio_Padrao'] = df.groupby('Complemento')['Custo_por_M2'].transform('std')
df['Alerta_IA'] = df['Custo_por_M2'] > (df['Media_Processo'] + (sensibilidade * df['Desvio_Padrao']))

# --- LAYOUT PRINCIPAL ---
st.title("üíé Smart Factory Analytics")
st.subheader("Gest√£o de Rochas Ornamentais & Detec√ß√£o de Desvios")

# KPIs de Gest√£o
c1, c2, c3, c4 = st.columns(4)
total_custo = df['Custo Padr√£o'].sum()
outliers_count = df[df['Alerta_IA'] == True].shape[0]

c1.metric("Custo Total Acumulado", f"R$ {total_custo:,.2f}")
c2.metric("Efici√™ncia M√©dia (R$/m¬≤)", f"R$ {df['Custo_por_M2'].mean():,.2f}")
c3.metric("Itens Cr√≠ticos (Outliers)", outliers_count, delta="Aten√ß√£o Necess√°ria", delta_color="inverse")
c4.metric("Consumo Total", f"{df['Consumo Total'].sum():,.2f} m¬≤")

st.divider()

# --- VISUALIZA√á√ÉO DE IMPACTO ---
col_main, col_audit = st.columns([6, 4])

with col_main:
    st.markdown("### üìä Vis√£o Geral de Custos")
    if estilo_grafico == "Barras":
        fig = px.bar(df, x="Complemento", y="Custo Padr√£o", color="Classifica√ß√£o Insumos", template=tema_ref)
    elif estilo_grafico == "Treemap":
        fig = px.treemap(df, path=['Complemento', 'Classifica√ß√£o Insumos', 'Processo'], values='Custo Padr√£o', template=tema_ref)
    else:
        fig = px.sunburst(df, path=['Complemento', 'Classifica√ß√£o Insumos'], values='Custo Padr√£o', template=tema_ref)
    st.plotly_chart(fig, use_container_width=True)

with col_audit:
    st.markdown("### üö® Auditoria Autom√°tica (IA)")
    # Lista apenas os produtos que a IA identificou como "caros" demais para o padr√£o daquela m√°quina
    df_alertas = df[df['Alerta_IA'] == True][['C√≥digo+Deriva√ß√£o', 'Complemento', 'Custo_por_M2', 'Media_Processo']].sort_values(by='Custo_por_M2', ascending=False)
    
    if not df_alertas.empty:
        st.error(f"Encontrados {len(df_alertas)} itens com custo fora do padr√£o!")
        st.dataframe(df_alertas, use_container_width=True, hide_index=True)
    else:
        st.success("Nenhum desvio cr√≠tico detectado nos processos atuais.")

# --- ANALISE DE EFICI√äNCIA ---
st.divider()
st.markdown("### üìà Dispers√£o: Custo vs. Consumo")
fig_scatter = px.scatter(df, x="Consumo Total", y="Custo_por_M2", color="Complemento", 
                         size="Custo Padr√£o", hover_name="C√≥digo+Deriva√ß√£o", 
                         title="An√°lise de Efici√™ncia por Lote", template=tema_ref)
st.plotly_chart(fig_scatter, use_container_width=True)